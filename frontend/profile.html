<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo | User Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .post-card { background-color: #ffffff; border: 1px solid #e2e8f0; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.25rem; font-weight: 700; color: #1e293b; }
        .stat-label { font-size: 0.875rem; color: #64748b; }
        .hidden { display: none; }

        /* --- NEW: Styles for the Tabs --- */
        .tab-button {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            color: #64748b; /* Slate 500 */
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }
        .tab-button.active {
            color: #059669; /* Green 600 */
            border-bottom-color: #059669;
        }
        
        /* --- NEW: Styles for Collection Cards --- */
        .collection-card {
            background-color: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: box-shadow 0.2s;
            cursor: pointer;
        }
        .collection-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.07);
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="flex min-h-screen">
        <aside class="w-64 flex-shrink-0 bg-white border-r border-gray-200 hidden md:block">
            <div class="p-6">
                <h1 class="text-3xl font-extrabold text-gray-800">
                    <span class="text-emerald-500">Echo</span>
                </h1>
            </div>
            <nav class="mt-6 px-4">
                <a href="index.html" class="sidebar-link flex items-center px-4 py-3 text-gray-500 hover:bg-gray-100 rounded-lg">
                    <i class="fas fa-home w-6 text-center"></i> <span class="ml-4">Home</span>
                </a>
                <a href="explore.html" class="sidebar-link flex items-center px-4 py-3 text-gray-500 hover:bg-gray-100 rounded-lg mt-2">
                    <i class="fas fa-compass w-6 text-center"></i> <span class="ml-4">Explore</span>
                </a>
                <a href="#" class="sidebar-link flex items-center px-4 py-3 text-gray-500 hover:bg-gray-100 rounded-lg mt-2">
                    <i class="fas fa-bell w-6 text-center"></i> <span class="ml-4">Notifications</span>
                </a>
                <a href="#" id="sidebar-profile-link" class="sidebar-link flex items-center px-4 py-3 text-gray-500 hover:bg-gray-100 rounded-lg mt-2">
                    <i class="fas fa-user w-6 text-center"></i> <span class="ml-4">Profile</span>
                </a>
                <div class="border-t my-4"></div>
            </nav>
            <div class="px-6 mt-8">
                <a href="create-post.html" class="block w-full text-center bg-emerald-500 text-white font-semibold px-5 py-3 rounded-lg hover:bg-emerald-600 transition-colors">
                    New Post
                </a>
            </div>
        </aside>

        <div class="flex-1 p-6 md:p-10">
            <div id="profile-header" class="max-w-2xl mx-auto mb-8 p-8 bg-white rounded-xl shadow-sm border border-gray-200">
                <div id="profile-loading" class="text-center">
                    <i class="fas fa-spinner fa-spin fa-2x text-gray-400"></i>
                </div>
                <div id="profile-content" class="hidden">
                    <div class="flex items-center">
                        <div id="profile-avatar" class="bg-gray-100 h-20 w-20 rounded-full flex items-center justify-center font-bold text-emerald-500 text-4xl"></div>
                        <div class="ml-6 flex-1">
                            <h2 id="profile-username" class="text-3xl font-bold text-gray-900">Username</h2>
                            <p id="profile-email" class="text-md text-gray-500">email@example.com</p>
                        </div>
                        <div id="follow-button-container" class="ml-4"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 mt-6 border-t border-gray-200 pt-6">
                        <div class="stat-item">
                            <div id="profile-post-count" class="stat-value">0</div>
                            <div class="stat-label">Posts</div>
                        </div>
                        <div class="stat-item">
                            <div id="profile-follower-count" class="stat-value">0</div>
                            <div class="stat-label">Followers</div>
                        </div>
                        <div class="stat-item">
                            <div id="profile-following-count" class="stat-value">0</div>
                            <div class="stat-label">Following</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="max-w-2xl mx-auto mb-6 border-b border-gray-200">
                <nav class="flex -mb-px">
                    <button id="posts-tab" class="tab-button active" onclick="showPostsTab()">
                        Posts
                    </button>
                    <button id="saved-tab" class="tab-button hidden" onclick="showSavedTab()">
                        Saved
                    </button>
                </nav>
            </div>

            <main class="max-w-2xl mx-auto">
                <div id="posts-container" class="space-y-8">
                    </div>
                
                <div id="saved-container" class="hidden space-y-4">
                    </div>
            </main>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = 'http://127.0.0.1:8000';
        
        // --- 1. Get User IDs ---
        const LOGGED_IN_USER_ID = parseFloat(localStorage.getItem('current_user_id'));
        const urlParams = new URLSearchParams(window.location.search);
        const USER_ID_TO_FETCH = parseFloat(urlParams.get('user_id')) || LOGGED_IN_USER_ID; 

        if(!LOGGED_IN_USER_ID) {
            // If no one is logged in, redirect to login page
            window.location.href = 'login.html';
            return;
        }

        // Update sidebar "Profile" link
        document.getElementById('sidebar-profile-link').href = `profile.html?user_id=${LOGGED_IN_USER_ID}`;

        // --- 2. Selectors ---
        const profileHeader = document.getElementById('profile-header');
        const profileLoading = document.getElementById('profile-loading');
        const profileContent = document.getElementById('profile-content');
        const followButtonContainer = document.getElementById('follow-button-container');
        
        const postsTab = document.getElementById('posts-tab');
        const savedTab = document.getElementById('saved-tab');
        const postsContainer = document.getElementById('posts-container');
        const savedContainer = document.getElementById('saved-container');
        
        let collectionsLoaded = false;

        // --- 3. Profile Header & Follow Logic ---
        async function fetchProfileData() {
            try {
                const response = await fetch(`${API_BASE_URL}/users/${USER_ID_TO_FETCH}`);
                if (!response.ok) throw new Error('Could not fetch user profile');
                const profile = await response.json();
                
                document.getElementById('profile-avatar').textContent = profile.username.charAt(0).toUpperCase();
                document.getElementById('profile-username').textContent = profile.username;
                document.getElementById('profile-email').textContent = profile.email;
                document.getElementById('profile-post-count').textContent = profile.post_count;
                document.getElementById('profile-follower-count').textContent = profile.follower_count;
                document.getElementById('profile-following-count').textContent = profile.following_count;

                profileLoading.classList.add('hidden');
                profileContent.classList.remove('hidden');

                if (LOGGED_IN_USER_ID === USER_ID_TO_FETCH) {
                    savedTab.classList.remove('hidden');
                } else {
                    fetchFollowStatus();
                }
            } catch (error) {
                console.error(error);
                profileHeader.innerHTML = `<p class="text-red-500 text-center">${error.message}</p>`;
            }
        }
        
        async function fetchFollowStatus() {
             try {
                const response = await fetch(`${API_BASE_URL}/users/${USER_ID_TO_FETCH}/is-following?follower_id=${LOGGED_IN_USER_ID}`);
                if (!response.ok) throw new Error('Could not check follow status');
                const data = await response.json();
                renderFollowButton(data.is_following);
            } catch (error) { console.error(error); }
        }
        function renderFollowButton(isFollowing) {
            if (isFollowing) {
                followButtonContainer.innerHTML = `<button id="follow-toggle-btn" class="px-5 py-2 rounded-lg bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300">Following</button>`;
            } else {
                followButtonContainer.innerHTML = `<button id="follow-toggle-btn" class="px-5 py-2 rounded-lg bg-emerald-500 text-white font-semibold hover:bg-emerald-600">Follow</button>`;
            }
            document.getElementById('follow-toggle-btn').addEventListener('click', handleFollowToggle);
        }
        async function handleFollowToggle() {
            const button = document.getElementById('follow-toggle-btn');
            button.disabled = true;
            try {
                const response = await fetch(`${API_BASE_URL}/users/${USER_ID_TO_FETCH}/follow`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: LOGGED_IN_USER_ID })
                });
                if (!response.ok) throw new Error('Follow request failed');
                const data = await response.json();
                renderFollowButton(data.is_following);
                document.getElementById('profile-follower-count').textContent = data.new_follower_count;
            } catch (error) { console.error(error); }
            finally { button.disabled = false; }
        }

        // --- 4. Tab Switching & Content Loading ---

        window.showPostsTab = function() {
            postsTab.classList.add('active');
            savedTab.classList.remove('active');
            postsContainer.classList.remove('hidden');
            savedContainer.classList.add('hidden');
        }

        window.showSavedTab = function() {
            postsTab.classList.remove('active');
            savedTab.classList.add('active');
            postsContainer.classList.add('hidden');
            savedContainer.classList.remove('hidden');
            
            if (!collectionsLoaded) {
                fetchSavedCollections();
                collectionsLoaded = true;
            }
        }

        // --- 5. Fetch/Render User's OWN Posts ---
        async function fetchUserPosts() {
            postsContainer.innerHTML = `<i class="fas fa-spinner fa-spin text-gray-400"></i>`;
            try {
                const response = await fetch(`${API_BASE_URL}/users/${USER_ID_TO_FETCH}/posts`);
                if (!response.ok) throw new Error('Could not fetch user posts');
                const posts = await response.json();
                displayPosts(posts, postsContainer);
            } catch (error) {
                console.error(error);
                postsContainer.innerHTML = `<p class="text-red-500 text-center">${error.message}</p>`;
            }
        }

        // --- 6. Fetch/Render Collections ---
        async function fetchSavedCollections() {
            savedContainer.innerHTML = `<i class="fas fa-spinner fa-spin text-gray-400"></i>`;
            try {
                const response = await fetch(`${API_BASE_URL}/users/${LOGGED_IN_USER_ID}/collections`);
                if (!response.ok) throw new Error('Could not fetch collections');
                
                const collections = await response.json();
                renderCollections(collections);
                
            } catch (error) {
                console.error(error);
                savedContainer.innerHTML = `<p class="text-red-500 text-center">${error.message}</p>`;
            }
        }
        
        function renderCollections(collections) {
            savedContainer.innerHTML = '';
            if (collections.length === 0) {
                savedContainer.innerHTML = `<p class="text-center text-gray-500 py-10">You haven't saved any posts yet.</p>`;
                return;
            }
            
            collections.forEach(collection => {
                const card = document.createElement('div');
                card.className = 'collection-card';
                card.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-900">${collection.name}</h3>
                    <p class="text-gray-500">${collection.post_count} posts</p>
                `;
                card.onclick = () => fetchPostsInCollection(collection.collection_id, collection.name);
                savedContainer.appendChild(card);
            });
        }
        
        // --- 7. Fetch/Render Posts in a Collection ---
       async function fetchPostsInCollection(collection_id, collection_name) {
            savedContainer.innerHTML = `
                <button id="back-to-collections-btn" class="mb-4 text-emerald-600 font-medium hover:text-emerald-800">
                    <i class="fas fa-arrow-left mr-2"></i> Back to all collections
                </button>
                <h2 class="text-2xl font-bold mb-6">${collection_name}</h2>
                <div id="collection-posts-list" class="space-y-8">
                    <i class="fas fa-spinner fa-spin text-gray-400"></i>
                </div>
            `;

            // 2. Add the event listener using JavaScript
            document.getElementById('back-to-collections-btn').addEventListener('click', fetchSavedCollections);
            

            try {
                const response = await fetch(`${API_BASE_URL}/collections/${collection_id}/posts?user_id=${LOGGED_IN_USER_ID}`);
                if (!response.ok) throw new Error('Could not fetch posts');
                
                const posts = await response.json();
                const container = document.getElementById('collection-posts-list');
                displayPosts(posts, container);
                
            } catch (error) {
                console.error(error);
                document.getElementById('collection-posts-list').innerHTML = `<p class="text-red-500">${error.message}</p>`;
            }
        }

        // --- 8. Generic Post Display Function ---
        function displayPosts(posts, container) {
            container.innerHTML = '';
            if (posts.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-10">No posts found.</p>`;
                return;
            }
            posts.forEach(post => {
                const postElement = document.createElement('article');
                postElement.className = 'post-card p-6 rounded-xl shadow-sm';
                const postDate = new Date(post.created_at).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
                
                const username = post.username || 'Unknown';

                postElement.innerHTML = `
                    <div class="flex items-center mb-4">
                        <div class="bg-gray-100 h-10 w-10 rounded-full flex items-center justify-center font-bold text-emerald-500">
                            ${username.charAt(0).toUpperCase()}
                        </div>
                        <div class="ml-4">
                            <a href="profile.html?user_id=${post.user_id}" class="font-semibold text-gray-900 hover:text-emerald-600">${username}</a>
                            <p class="text-sm text-gray-500">${postDate}</p>
                        </div>
                    </div>
                    <a href="index.html?post_id=${post.post_id}" 
                       class="text-2xl font-bold text-gray-800 hover:text-emerald-600">${post.title}</a>
                    <div class="mt-5 flex items-center text-gray-500 text-sm space-x-6 border-t border-gray-200 pt-4">
                        <span class="flex items-center"><i class="far fa-heart mr-2"></i> ${post.likes_count} Likes</span>
                        <span class="flex items-center"><i class="far fa-comment-dots mr-2"></i> ${post.comments_count || 0} Comments</span>
                        <span class="flex items-center"><i class="far fa-eye mr-2"></i> ${post.views_count} Views</span>
                    </div>
                `;
                container.appendChild(postElement);
            });
        }

        // --- 9. Initial Page Load ---
        fetchProfileData();
        showPostsTab(); // Show the "Posts" tab by default
        fetchUserPosts(); // Fetch the user's posts by default
    });
</script>

</body>
</html>