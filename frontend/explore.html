<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo | Explore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .post-card { background-color: #ffffff; border: 1px solid #e2e8f0; }
        .sidebar-link.active { background-color: #ecfdf5; color: #059669; font-weight: 600; }
        .hidden { display: none; }
        .result-heading { font-size: 1.25rem; font-weight: 700; color: #1e293b; padding-bottom: 0.75rem; border-bottom: 2px solid #e2e8f0; margin-bottom: 1.5rem; }
        .user-card, .tag-card { background-color: #fff; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1rem; display: flex; align-items: center; transition: box-shadow 0.2s; }
        .user-card:hover, .tag-card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.07); }
        .tag { display: inline-block; background-color: #ecfdf5; color: #059669; font-size: 0.75rem; font-weight: 500; padding: 0.25rem 0.75rem; border-radius: 9999px; margin-right: 0.5rem; margin-top: 0.5rem; text-decoration: none; transition: background-color 0.2s; }
        .tag:hover { background-color: #d1fae5; }
        .modal-open { overflow: hidden; }
        #collections-list li label { display: flex; align-items: center; width: 100%; font-size: 1rem; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; }
        #collections-list li label:hover { background-color: #f8fafc; }
        #collections-list li input[type="checkbox"] { width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; accent-color: #10b981; }

        /* In explore.html, inside the <style> tag */

    .tag {
        display: inline-block;
        background-color: #ecfdf5; /* Green 50 */
        color: #059669; /* Green 600 */
        font-size: 0.75rem; /* 12px */
        font-weight: 500;
        padding: 0.25rem 0.75rem; /* 4px 12px */
        border-radius: 9999px; /* full pill shape */
        margin-right: 0.5rem;
        margin-top: 0.5rem;
        text-decoration: none;
        transition: background-color 0.2s;
    }
    .tag:hover {
        background-color: #d1fae5; /* Green 100 */
    }


    </style>
</head>
<body class="text-gray-800">

    <div class="flex min-h-screen">
        <div id="sidebar-placeholder"></div>

        <div id="app" class="flex-1 p-6 md:p-10">
            
            <header id="feed-header" class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900">Explore</h2>
                <p class="text-gray-500 mt-1">Discover new posts, users, and topics.</p>
                <form id="search-form" class="mt-6">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <input type="search" id="search-input" class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg text-lg" placeholder="Search for posts, users, or tags...">
                    </div>
                </form>
            </header>

            <main>
                <div id="results-container" class="max-w-2xl mx-auto">
                    <div id="loading-indicator" class="text-center py-20">
                        <i class="fas fa-spinner fa-spin fa-3x text-gray-400"></i>
                    </div>
                </div>

                <div id="post-detail-container" class="hidden max-w-2xl mx-auto">
                    </div>
            </main>
        </div>
    </div>

    <div id="bookmark-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div onclick="closeBookmarkModal()" class="absolute inset-0 bg-black/50"></div>
        <div class="relative w-full max-w-md bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Save to...</h3>
            <div id="collections-loading" class="text-center">
                 <i class="fas fa-spinner fa-spin text-gray-400"></i>
            </div>
            <ul id="collections-list" class="space-y-3 max-h-60 overflow-y-auto mb-4"></ul>
            <form id="create-collection-form" class="flex items-center border-t border-gray-200 pt-4">
                <input type="text" id="new-collection-name" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" placeholder="New collection name..." required>
                <button type="submit" class="ml-3 px-4 py-2 bg-emerald-500 text-white font-semibold rounded-lg hover:bg-emerald-600">
                    Create
                </button>
            </form>
            <div class="flex justify-end border-t border-gray-200 pt-4 mt-4">
                <button onclick="closeBookmarkModal()" type="button" class="px-5 py-2 rounded-lg bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200">
                    Cancel
                </button>
                <button id="save-bookmarks-btn" type="button" class="ml-3 px-5 py-2 rounded-lg bg-emerald-500 text-white font-semibold hover:bg-emerald-600">
                    Save
                </button>
            </div>
        </div>
    </div>
    
    <script src="app-shell.js"></script>

    <script>
        // Note: LOGGED_IN_USER_ID is defined in app-shell.js
        // It will be null if the user is a guest.
        
        document.addEventListener('DOMContentLoaded', () => {
            
            const API_BASE_URL = 'http://127.0.0.1:8000';
            
            // --- Page Selectors ---
            const resultsContainer = document.getElementById('results-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            const searchForm = document.getElementById('search-form');
            const searchInput = document.getElementById('search-input');
            const postDetailContainer = document.getElementById('post-detail-container');
            const feedHeader = document.getElementById('feed-header');
            
            // --- Modal Selectors ---
            const bookmarkModal = document.getElementById('bookmark-modal');
            const collectionsList = document.getElementById('collections-list');
            const collectionsLoading = document.getElementById('collections-loading');
            const createCollectionForm = document.getElementById('create-collection-form');
            const newCollectionNameInput = document.getElementById('new-collection-name');
            const saveBookmarksBtn = document.getElementById('save-bookmarks-btn');
            
            let currentPostIdToBookmark = null;
            let initialBookmarkedIds = new Set();
            
            // --- NEW: Helper function for auth "toast" ---
            function showLoginAlert() {
                if (confirm("Please log in or create an account to do that.\n\nGo to the login page?")) {
                    window.location.href = 'login.html';
                }
            }

            // --- 1. Explore Feed Logic ---
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const query = searchInput.value;
                if (query) performSearch(query);
                else fetchDefaultPosts();
            });
            searchInput.addEventListener('search', () => {
                if (!searchInput.value) fetchDefaultPosts();
            });

            async function performSearch(query) {
                showFeedView(); // Show the feed
                loadingIndicator.style.display = 'block';
                resultsContainer.innerHTML = ''; 
                try {
                    const response = await fetch(`${API_BASE_URL}/search?q=${encodeURIComponent(query)}`); 
                    if (!response.ok) throw new Error('Search request failed');
                    const results = await response.json();
                    displayResults(results);
                } catch (error) {
                    console.error("Failed to fetch search results:", error);
                    loadingIndicator.style.display = 'none';
                    resultsContainer.innerHTML = `<p class="text-red-500 text-center">Error: ${error.message}</p>`;
                }
            }
            
            async function fetchDefaultPosts() {
                showFeedView(); // Show the feed
                loadingIndicator.style.display = 'block';
                resultsContainer.innerHTML = '';
                try {
                    const response = await fetch(`${API_BASE_URL}/posts/?limit=20&offset=0`); 
                    if (!response.ok) throw new Error('Could not load posts');
                    const posts = await response.json();
                    displayResults({ posts: posts, users: [], tags: [] });
                } catch (error) {
                    console.error("Failed to fetch posts:", error);
                    loadingIndicator.style.display = 'none';
                    resultsContainer.innerHTML = `<p class="text-red-500 text-center">Error: ${error.message}</p>`;
                }
            }

            function displayResults(results) {
                loadingIndicator.style.display = 'none';
                resultsContainer.innerHTML = '';
                let html = '';
                const { users, tags, posts } = results;

                if (users.length === 0 && tags.length === 0 && posts.length === 0) {
                    resultsContainer.innerHTML = `<p class="text-center text-gray-500 py-20">No results found.</p>`;
                    return;
                }
                
                // (User and Tag display logic is unchanged)
                if (users.length > 0) {
                    html += '<section id="user-results" class="mb-8"><h2 class="result-heading">Users</h2><div class="space-y-4">';
                    users.forEach(user => { html += `<a href="profile.html?user_id=${user.user_id}" class="user-card"><div class="bg-gray-100 ...">${user.username.charAt(0).toUpperCase()}</div><div class="ml-4"><p class="font-semibold ...">${user.username}</p><p class="text-sm ...">${user.email}</p></div></a>`; });
                    html += '</div></section>';
                }
                if (tags.length > 0) {
                    html += '<section id="tag-results" class="mb-8"><h2 class="result-heading">Tags</h2><div class="space-y-4">';
                    tags.forEach(tag => { html += `<a href="#" onclick="event.preventDefault(); searchInput.value='${tag.name}'; performSearch('${tag.name}');" class="tag-card ..."><div><p class="font-semibold ...">#${tag.name}</p></div><span class="text-sm ...">${tag.post_count} posts</span></a>`; });
                    html += '</div></section>';
                }

                // (Post display logic is updated)
                if (posts.length > 0) {
                    html += '<section id="post-results">';
                    if (users.length > 0 || tags.length > 0) {
                         html += '<h2 class="result-heading">Posts</h2>';
                    }
                    html += '<div class="space-y-8">';
                    posts.forEach(post => {
                        const postDate = new Date(post.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                        const username = post.username || 'Unknown';
                        let tagsHTML = '';
                        if (post.categories) { 
                            const tags = post.categories.split(',');
                            tags.forEach(tag => {
                                tagsHTML += `<a href="#" onclick="event.preventDefault(); searchInput.value='${tag}'; performSearch('${tag}');" class="tag">#${tag}</a>`;
                            });
                        }
                        
                        html += `
                            <article class="post-card p-6 rounded-xl shadow-sm">
                                <div class="flex items-center mb-4">
                                    <div class="bg-gray-100 h-11 w-11 rounded-full flex items-center justify-center font-bold text-emerald-500 text-lg">
                                        ${username.charAt(0).toUpperCase()}
                                    </div>
                                    <div class="ml-4">
                                        <a href="profile.html?user_id=${post.user_id}" class="font-semibold text-gray-900 hover:text-emerald-600">${username}</a>
                                        <p class="text-sm text-gray-500">${postDate}</p>
                                    </div>
                                </div>
                                <a href="#" onclick="event.preventDefault(); showPostDetails(${post.post_id})" 
                                   class="text-2xl font-bold ...">${post.title}</a>
                                <div class="mt-2 flex flex-wrap">${tagsHTML}</div>
                                <p class="mt-3 text-gray-600">${post.content.substring(0, 150)}...</p>
                            
                            <div class="mt-5 flex items-center text-gray-500 text-sm space-x-6 border-t border-gray-200 pt-4">
                                <button onclick="toggleLike(${post.post_id}, this, false)" 
                                        class="flex items-center hover:text-red-500 transition-colors duration-300">
                                    <i class="far fa-heart mr-2"></i> 
                                    <span class="like-count">${post.likes_count}</span>&nbsp;Likes
                                </button>
                                <div class="flex items-center">
                                    <i class="far fa-comment-dots mr-2"></i> ${post.comments_count || 0} Comments
                                </div>
                                <div class="flex items-center">
                                    <i class="far fa-eye mr-2"></i> ${post.views_count} Views
                                </div>
                                <div class="flex-1 flex justify-end">
                                    <button onclick="openBookmarkModal(${post.post_id})" 
                                            class="flex items-center hover:text-emerald-600 transition-colors duration-300">
                                        <i class="far fa-bookmark text-lg"></i>
                                    </button>
                                </div>
                            </div>
                            </article>
                        `;
                    });
                    html += '</div></section>';
                }
                resultsContainer.innerHTML = html;
            }
            
            // --- 2. Single Post Detail Logic (Copied from index.html) ---
            
            function showFeedView() {
                postDetailContainer.classList.add('hidden');
                feedHeader.classList.remove('hidden');
                resultsContainer.classList.remove('hidden');
                history.pushState(null, '', 'explore.html');
            }

            window.showPostDetails = async function(post_id) {
                resultsContainer.classList.add('hidden');
                feedHeader.classList.add('hidden');
                postDetailContainer.classList.remove('hidden');
                postDetailContainer.innerHTML = `<div class="text-center py-20"><i class="fas fa-spinner fa-spin fa-3x text-gray-400"></i></div>`;
                history.pushState(null, '', `explore.html?post_id=${post_id}`);
                try {
                    const safe_user_id = LOGGED_IN_USER_ID || 0; // Pass 0 if logged out
                    const [postRes, commentsRes] = await Promise.all([
                        fetch(`${API_BASE_URL}/posts/${post_id}?user_id=${safe_user_id}`),
                        fetch(`${API_BASE_URL}/posts/${post_id}/comments`) 
                    ]);
                    if (!postRes.ok || !commentsRes.ok) throw new Error('Failed to load post details');
                    const post = await postRes.json();
                    const comments = await commentsRes.json();
                    displayPostDetails(post[0], comments); 
                } catch (error) {
                    console.error("Failed to fetch post details:", error);
                    postDetailContainer.innerHTML = `<p class="text-red-500">Error loading post.</p>`;
                }
            }
            
            function displayPostDetails(post, comments) {
            const postDate = new Date(post.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const isLiked = post.is_liked_by_user;
            const likeIconClass = isLiked ? 'fas fa-heart text-red-500' : 'far fa-heart';
            const likeButtonClass = isLiked ? 'text-red-500' : 'hover:text-red-500';
            const username = post.username || 'Unknown';
            let tagsHTML = '';
            if (post.categories) {
                const tags = post.categories.split(',');
                tags.forEach(tag => {
                    tagsHTML += `<a href="explore.html?q=${encodeURIComponent(tag)}" class="tag">#${tag}</a>`;
                });
            }
            
            let postHTML = `
                <div>
                    <div class="flex justify-between items-center mb-6">
                        <button onclick="showFeedView()" class="text-emerald-600 hover:text-emerald-800 font-medium">
                            <i class="fas fa-arrow-left mr-2"></i> Back to Explore
                        </button>
                        ${post.user_id == LOGGED_IN_USER_ID ? `
                            <button onclick="handleDeletePost(${post.post_id}, '${post.title.replace(/'/g, "\\'")}')" 
                                    class="px-4 py-2 rounded-lg bg-red-50 text-red-700 font-semibold hover:bg-red-100">
                                <i class="fas fa-trash-alt mr-2"></i> Delete Post
                            </button>
                        ` : ''}
                    </div>
                    <div class="flex items-center mb-4">
                        <div class="bg-gray-100 h-11 w-11 rounded-full flex items-center justify-center font-bold text-emerald-500 text-lg">
                            ${username.charAt(0).toUpperCase()}
                        </div>
                        <div class="ml-4">
                            <a href="profile.html?user_id=${post.user_id}" class="font-semibold text-gray-900 hover:text-emerald-600">${username}</a>
                            <p class="text-sm text-gray-500">${postDate}</p>
                        </div>
                    </div>
                    <h1 class="text-4xl font-extrabold text-gray-900 leading-tight mb-4">${post.title}</h1>
                    <div class="mt-2 flex flex-wrap">${tagsHTML}</div>
                    <div class="text-gray-700 text-lg leading-relaxed space-y-4 mt-4">
                        <p>${post.content.replace(/\n/g, '<br>')}</p>
                    </div>
                    <div class="mt-8 flex items-center text-gray-500 text-sm space-x-6 border-t border-b border-gray-200 py-4">
                        <button onclick="toggleLike(${post.post_id}, this, true)" 
                                class="flex items-center transition-colors duration-300 ${likeButtonClass}">
                            <i class="${likeIconClass} mr-2"></i> 
                            <span class="like-count">${post.likes_count}</span>&nbsp;Likes
                        </button>
                        <div class="flex items-center">
                            <i class="far fa-comment-dots mr-2"></i> ${post.comments_count || 0} Comments
                        </div>
                        <div class="flex items-center">
                            <i class="far fa-eye mr-2"></i> ${post.views_count} Views
                        </div>
                        <div class="flex-1 flex justify-end">
                            <button onclick="openBookmarkModal(${post.post_id})" 
                                    class="flex items-center hover:text-emerald-600 transition-colors duration-300">
                                <i class="far fa-bookmark text-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            if (LOGGED_IN_USER_ID) {
                postHTML += `
                    <div class="mt-8">
                        <h3 class="text-xl font-bold mb-4">Add a Comment</h3>
                        <form onsubmit="handleCommentSubmit(event, ${post.post_id})">
                            <textarea id="comment-content" class="w-full p-3 border border-gray-300 rounded-lg" rows="4" placeholder="Write your thoughts..." required></textarea>
                            <button type="submit" class="mt-3 bg-emerald-500 text-white font-semibold px-5 py-2 rounded-lg hover:bg-emerald-600">Post Comment</button>
                        </form>
                    </div>
                `;
            } else {
                postHTML += `
                    <div class="mt-8 text-center p-4 bg-gray-50 rounded-lg">
                        <p class="text-gray-600">
                            <a href="login.html" class="font-bold text-emerald-600 hover:underline">Log in</a> or 
                            <a href="signup.html" class="font-bold text-emerald-600 hover:underline">sign up</a> to leave a comment.
                        </p>
                    </div>
                `;
            }
            
            postHTML += `<div id="comments-list" class="mt-8 space-y-6">`;
            if (comments.length === 0) { postHTML += `<p class="text-gray-500">No comments yet.</p>`; }
            else {
                comments.forEach(comment => {
                    const commentDate = new Date(comment.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    postHTML += `
                        <div class="flex">
                            <div class="flex-shrink-0 bg-gray-100 h-10 w-10 rounded-full flex items-center justify-center font-bold text-gray-500 text-md">
                                ${comment.username.charAt(0).toUpperCase()}
                            </div>
                            <div class="ml-4">
                                <p class="font-semibold text-gray-900">
                                    <a href="profile.html?user_id=${comment.user_id}" class="hover:text-emerald-600">${comment.username}</a>
                                    <span class="text-sm text-gray-500 font-normal ml-2">${commentDate}</span>
                                </p>
                                <p class="text-gray-700 mt-1">${comment.content}</p>
                            </div>
                        </div>
                    `;
                });
            }
            postHTML += `</div>`;
            postDetailContainer.innerHTML = postHTML;
}

            // --- 3. Core Action Functions (with Auth Guards) ---
            
            window.toggleLike = async function(post_id, buttonElement, isDetailPage) {
                if (!LOGGED_IN_USER_ID) { showLoginAlert(); return; }
                try {
                    const response = await fetch(`${API_BASE_URL}/posts/${post_id}/like`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: LOGGED_IN_USER_ID }) });
                    if (!response.ok) throw new Error('Like request failed');
                    const result = await response.json(); 
                    const likeState = result[0]; 
                    const countSpan = buttonElement.querySelector('.like-count');
                    countSpan.textContent = likeState.new_count;
                    if (isDetailPage) {
                        const icon = buttonElement.querySelector('i');
                        if (likeState.liked) { icon.className = 'fas fa-heart mr-2'; buttonElement.classList.add('text-red-500'); }
                        else { icon.className = 'far fa-heart mr-2'; buttonElement.classList.remove('text-red-500'); }
                    }
                } catch (error) { console.error("Failed to toggle like:", error); }
            }

            window.handleCommentSubmit = async function(event, post_id) {
                event.preventDefault();
                if (!LOGGED_IN_USER_ID) { showLoginAlert(); return; }
                const contentElement = document.getElementById('comment-content');
                const content = contentElement.value;
                if (!content) return;
                try {
                    const response = await fetch(`${API_BASE_URL}/posts/${post_id}/comments`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: LOGGED_IN_USER_ID, content: content }) });
                    if (!response.ok) throw new Error('Failed to post comment');
                    contentElement.value = '';
                    showPostDetails(post_id); 
                } catch (error) { console.error("Failed to post comment:", error); }
            }
            
            window.handleDeletePost = async function(post_id, post_title) {
                if (!LOGGED_IN_USER_ID) { showLoginAlert(); return; }
                if (!confirm(`Are you sure you want to delete this post?\n\n"${post_title}"`)) return;
                try {
                    const response = await fetch(`${API_BASE_URL}/posts/${post_id}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: LOGGED_IN_USER_ID })
                    });
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Failed to delete post');
                    }
                    alert('Post deleted successfully.');
                    showFeedView(); // Go back to explore feed
                } catch (error) {
                    console.error('Error deleting post:', error);
                    alert(`Error: ${error.message}`);
                }
            }
            
            // --- 4. Bookmark Modal Functions (with Auth Guards) ---
            
            window.openBookmarkModal = function(post_id) {
                if (!LOGGED_IN_USER_ID) { showLoginAlert(); return; }
                currentPostIdToBookmark = post_id;
                collectionsList.innerHTML = ''; 
                collectionsLoading.style.display = 'block';
                bookmarkModal.classList.remove('hidden');
                document.body.classList.add('modal-open');
                fetchCollectionsAndStatus();
            }

            window.closeBookmarkModal = function() {
                bookmarkModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
                currentPostIdToBookmark = null;
                initialBookmarkedIds.clear(); 
            }
            
            async function fetchCollectionsAndStatus() {
                try {
                    const [collectionsRes, statusRes] = await Promise.all([
                        fetch(`${API_BASE_URL}/users/${LOGGED_IN_USER_ID}/collections`),
                        fetch(`${API_BASE_URL}/posts/${currentPostIdToBookmark}/bookmark-status?user_id=${LOGGED_IN_USER_ID}`)
                    ]);
                    if (!collectionsRes.ok || !statusRes.ok) throw new Error('Failed to load collections');
                    const collections = await collectionsRes.json();
                    const bookmarkedInIds = await statusRes.json();
                    initialBookmarkedIds = new Set(bookmarkedInIds);
                    renderCollectionsList(collections);
                } catch (error) {
                    console.error(error);
                    collectionsList.innerHTML = `<p class="text-red-500">Could not load collections.</p>`;
                } finally {
                    collectionsLoading.style.display = 'none';
                }
            }
            
            function renderCollectionsList(collections) {
                // (This function is unchanged)
                collectionsList.innerHTML = '';
                if (collections.length === 0) { collectionsList.innerHTML = `<p class="text-gray-500 ...">No collections yet.</p>`; }
                collections.forEach(collection => {
                    const isChecked = initialBookmarkedIds.has(collection.collection_id);
                    const li = document.createElement('li');
                    li.innerHTML = `<label><input type="checkbox" data-collection-id="${collection.collection_id}" ${isChecked ? 'checked' : ''}><span class="font-medium">${collection.name}</span><span class="ml-auto ...">${collection.post_count} posts</span></label>`;
                    collectionsList.appendChild(li);
                });
            }
            
            function addBookmark(collectionId) {
                return fetch(`${API_BASE_URL}/bookmarks/`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: LOGGED_IN_USER_ID, post_id: currentPostIdToBookmark, collection_id: collectionId }) });
            }

            function removeBookmark(collectionId) {
                const params = new URLSearchParams({ user_id: LOGGED_IN_USER_ID, post_id: currentPostIdToBookmark, collection_id: collectionId });
                return fetch(`${API_BASE_URL}/bookmarks/?${params}`, { method: 'DELETE' });
            }

            async function handleSaveBookmarks() {
                saveBookmarksBtn.disabled = true;
                saveBookmarksBtn.textContent = 'Saving...';
                const promises = [];
                const checkboxes = collectionsList.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    const collectionId = parseFloat(checkbox.dataset.collectionId);
                    const isChecked = checkbox.checked;
                    const wasChecked = initialBookmarkedIds.has(collectionId);
                    if (isChecked && !wasChecked) { promises.push(addBookmark(collectionId)); }
                    else if (!isChecked && wasChecked) { promises.push(removeBookmark(collectionId)); }
                });
                try {
                    await Promise.all(promises);
                } catch (error) {
                    console.error("Failed to save bookmarks:", error);
                    alert("An error occurred while saving. Please try again.");
                } finally {
                    saveBookmarksBtn.disabled = false;
                    saveBookmarksBtn.textContent = 'Save';
                    closeBookmarkModal(); 
                }
            }
            
            createCollectionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = newCollectionNameInput.value;
                if (!newName) return;
                try {
                    const response = await fetch(`${API_BASE_URL}/collections/`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: newName, user_id: LOGGED_IN_USER_ID }) });
                    if (!response.ok) throw new Error('Failed to create collection');
                    newCollectionNameInput.value = '';
                    fetchCollectionsAndStatus();
                } catch (error) {
                    console.error(error);
                    alert(error.message);
                }
            });
            
            saveBookmarksBtn.addEventListener('click', handleSaveBookmarks);

            // --- 5. Initial Page Load ---
            const urlParams = new URLSearchParams(window.location.search);
            const postIdFromUrl = urlParams.get('post_id');
            const queryFromUrl = urlParams.get('q');
            
            if (postIdFromUrl) {
                // If a post_id is in the URL, show that post's details
                showPostDetails(postIdFromUrl);
            } else if (queryFromUrl) {
                // If a search query is in the URL, perform search
                searchInput.value = queryFromUrl;
                performSearch(queryFromUrl);
            } else {
                // Otherwise, just fetch the main feed
                fetchDefaultPosts();
            }
        });
    </script>

</body>
</html>